@page "/learning/{SubjectId}/{TopicId}/{CurrentView?}"
@page "/learning-centre/{SubjectId}/flowcharts/{TopicId}"
@using MedicalSite.Features.Learning.Models
@using MedicalSite.Features.Learning.Services
@using MedicalSite.Features.Learning.Components
@inject LearningService LearningService
@inject NavigationManager Nav

<!-- Background: Subtle gradient -->
<div class="fixed top-0 right-0 w-[600px] h-[600px] bg-indigo-500/10 rounded-full blur-3xl -z-10 pointer-events-none"></div>

<div class="max-w-7xl mx-auto pb-20 px-4 sm:px-6">
    @if (CurrentTopic == null)
    {
        <div class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
            <p class="text-slate-500 font-semibold animate-pulse">Loading...</p>
        </div>
    }
    else
    {
        <!-- HEADER -->
        <div class="mb-8 p-8 rounded-3xl bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border border-white/50 dark:border-slate-700 shadow-sm">
            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-indigo-600 dark:text-indigo-400 mb-3">
                <a href="learning-centre" class="hover:underline opacity-70">Centre</a>
                <span class="opacity-50">/</span>
                <span class="opacity-70">@SubjectId</span>
            </div>
            <h1 class="text-4xl md:text-6xl font-black text-slate-900 dark:text-white tracking-tight">
                @CurrentTopic.Title
            </h1>
        </div>

        <!-- TABS (Updated: High Contrast Buttons) -->
        <div class="flex justify-center mb-10 gap-3">
            <button @onclick='() => Navigate("overview")' class="@GetTabClass("overview")">
                ðŸ“– Notes
            </button>
            <button @onclick='() => Navigate("flashcards")' class="@GetTabClass("flashcards")">
                âš¡ Cards
            </button>
            <button @onclick='() => Navigate("flowcharts")' class="@GetTabClass("flowcharts")">
                ðŸŒ³ Flow
            </button>
        </div>

        @if (NormalizedView == "overview")
        {
            <div class="flex flex-col lg:flex-row gap-8 relative">
                
                <!-- SIDEBAR (Contents) -->
                <div class="w-full lg:w-1/4 flex-shrink-0 z-10">
                    <div class="sticky top-6 bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 shadow-sm">
                        <h3 class="text-xs font-black uppercase text-slate-400 mb-4 tracking-wider px-2">Table of Contents</h3>
                        <div class="flex flex-col gap-2 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                            @foreach (var item in CurrentTopic.Sections)
                            {
                                <button @onclick="() => ActiveSection = item"
                                        class="text-left px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 border
                                        @(ActiveSection == item 
                                            ? "bg-indigo-600 text-white border-indigo-600 shadow-md" 
                                            : "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-transparent hover:bg-slate-200 dark:hover:bg-slate-600")">
                                    @item.Title
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <!-- MAIN CONTENT -->
                <div class="w-full lg:w-3/4 min-h-[600px]">
                    @if (ActiveSection != null)
                    {
                        <div @key="ActiveSection" class="animate-spring-up relative bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                            
                            <!-- Colorful Side Bar -->
                            <div class="absolute left-0 top-0 bottom-0 w-2 bg-gradient-to-b from-indigo-500 via-purple-500 to-pink-500"></div>

                            <div class="p-8 md:p-12">
                                <!-- SECTION TITLE -->
                                <div class="flex flex-wrap items-center gap-4 mb-8 border-b border-slate-100 dark:border-slate-700 pb-6">
                                    <h2 class="text-3xl font-bold text-indigo-900 dark:text-indigo-900">
                                        @ActiveSection.Title
                                    </h2>
                                    @if(ActiveSection.IsExamPearl) 
                                    { 
                                        <span class="px-3 py-1 bg-amber-100 text-amber-800 text-xs font-bold uppercase rounded-full border border-amber-200">
                                            High Yield
                                        </span> 
                                    }
                                </div>
                                
                                <!-- CONTENT TEXT -->
                                <div class="prose dark:prose-invert max-w-none 
                                            text-lg leading-loose
                                            text-slate-800 dark:text-black 
                                            font-medium whitespace-pre-line">
                                    @ActiveSection.Content
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else if (NormalizedView == "flashcards")
        {
            <div class="animate-spring-up">
                <FlashcardDeck Cards="CurrentTopic.Flashcards" />
            </div>
        }
        else if (NormalizedView == "flowcharts")
        {
            <div class="animate-spring-up overflow-x-auto p-8 bg-white dark:bg-slate-800 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-lg">
                    <FlowchartTree Node="CurrentTopic.RootFlowchartNode" />
            </div>
        }
    }
</div>

@code {
    [Parameter] public string SubjectId { get; set; } = "";
    [Parameter] public string TopicId { get; set; } = "";
    [Parameter] public string? CurrentView { get; set; }

    private Topic? CurrentTopic;
    private ContentSection? ActiveSection;
    private string NormalizedView => (CurrentView ?? "overview").ToLower();

    protected override async Task OnParametersSetAsync()
    {
        CurrentTopic = await LearningService.GetTopicAsync(SubjectId, TopicId);
        
        if (CurrentTopic != null && CurrentTopic.Sections.Any() && ActiveSection == null)
        {
            ActiveSection = CurrentTopic.Sections.First();
        }

        if (Nav.Uri.Contains("/flowcharts/") && string.IsNullOrEmpty(CurrentView))
        {
            CurrentView = "flowcharts";
        }
    }

    private void Navigate(string view) 
    {
        Nav.NavigateTo($"learning/{SubjectId}/{TopicId}/{view}");
    }

    // UPDATED TAB COLORS
    private string GetTabClass(string viewName)
    {
        bool isActive = NormalizedView == viewName;
        
        return isActive 
            // ACTIVE: Indigo Background, White Text
            ? "px-6 py-2.5 rounded-full bg-indigo-600 text-white font-bold shadow-lg transition-all transform scale-105" 
            
            // INACTIVE: Grey Background (Contrast), Dark Text
            : "px-6 py-2.5 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-all";
    }
}