@page "/learning-centre/microbiology/flowcharts"
@inject IJSRuntime JSRuntime
@using System.Text.Json

<div class="flex h-[calc(100vh-8rem)] flex-col gap-4 p-4">
    <!-- Toolbar -->
    <div class="flex items-center justify-between rounded-xl border border-[var(--app-border)] bg-[var(--app-surface)] p-4 shadow-sm">
        <div class="flex gap-4">
            <h1 class="text-xl font-bold text-[var(--app-text)]">Microbiology Flows</h1>
            <div class="h-8 w-px bg-gray-300 dark:bg-slate-600"></div>
            <button @onclick="AddNode" class="rounded-lg bg-blue-100 px-4 py-1 text-sm font-medium text-blue-700 hover:bg-blue-200 dark:bg-blue-900/30 dark:text-blue-300">+ Add Node</button>
            <button @onclick="ClearAll" class="rounded-lg bg-red-100 px-4 py-1 text-sm font-medium text-red-700 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-300">Clear All</button>
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400">
            @if (SelectedNodeId != null) { <span class="text-blue-600 dark:text-blue-400">Select another node to connect</span> } else { <span>Click to connect • Drag to move</span> }
        </div>
    </div>

    <!-- Canvas -->
    <div class="relative flex-1 overflow-hidden rounded-xl border border-[var(--app-border)] bg-slate-50 shadow-inner dark:bg-slate-900" @onmousemove="OnMouseMove" @onmouseup="OnMouseUp">
        <svg class="pointer-events-none absolute inset-0 h-full w-full">
            @foreach (var conn in Connections)
            {
                var f = Nodes.FirstOrDefault(n => n.Id == conn.FromId);
                var t = Nodes.FirstOrDefault(n => n.Id == conn.ToId);
                if (f != null && t != null) { <line x1="@(f.X+64)" y1="@(f.Y+24)" x2="@(t.X+64)" y2="@(t.Y+24)" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowhead)" /> }
            }
            <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" /></marker></defs>
        </svg>

        @foreach (var node in Nodes)
        {
            <div class="absolute flex w-32 cursor-move flex-col items-center justify-center rounded-lg border bg-white px-2 py-2 shadow-md hover:shadow-lg dark:border-slate-600 dark:bg-slate-800"
                 style="left:@(node.X)px; top:@(node.Y)px; z-index:10; border-color:@(SelectedNodeId==node.Id?"#3b82f6":"")"
                 @onmousedown="@(e => OnMouseDown(e, node))" @onclick="@(() => OnNodeClick(node))" @onclick:stopPropagation="true">
                <input value="@node.Text" @onchange="@(e => UpdateNodeText(node, e.Value?.ToString()))" class="w-full bg-transparent text-center text-xs font-medium text-gray-800 focus:outline-none dark:text-gray-200" />
                <button @onclick="@(() => DeleteNode(node))" class="absolute -right-2 -top-2 hidden h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white hover:bg-red-600 group-hover:flex">×</button>
            </div>
        }
    </div>
</div>

@code {
    private const string StorageKey = "micro_flowchart";
    private List<Node> Nodes = new();
    private List<Connection> Connections = new();
    private Guid? SelectedNodeId;
    private bool IsDragging;
    private Node? DraggingNode;
    private double DragOffsetX, DragOffsetY;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var json = await JSRuntime.InvokeAsync<string>("appStorage.load", StorageKey);
            if (!string.IsNullOrEmpty(json)) { try { var d = JsonSerializer.Deserialize<FlowData>(json); Nodes = d?.Nodes ?? new(); Connections = d?.Connections ?? new(); StateHasChanged(); } catch {} }
        }
    }

    private void AddNode() { Nodes.Add(new Node { Id = Guid.NewGuid(), X = 50 + Nodes.Count * 20, Y = 50 + Nodes.Count * 20, Text = "New Node" }); SaveData(); }
    private void DeleteNode(Node n) { Nodes.Remove(n); Connections.RemoveAll(c => c.FromId == n.Id || c.ToId == n.Id); if(SelectedNodeId == n.Id) SelectedNodeId = null; SaveData(); }
    private void ClearAll() { Nodes.Clear(); Connections.Clear(); SelectedNodeId = null; SaveData(); }
    private void OnNodeClick(Node n) { if(IsDragging) return; if(SelectedNodeId == null) SelectedNodeId = n.Id; else if(SelectedNodeId != n.Id) { if(!Connections.Any(c => c.FromId == SelectedNodeId && c.ToId == n.Id)) Connections.Add(new Connection { FromId = SelectedNodeId.Value, ToId = n.Id }); SelectedNodeId = null; SaveData(); } else SelectedNodeId = null; }
    private void UpdateNodeText(Node n, string? t) { n.Text = t ?? ""; SaveData(); }
    private void OnMouseDown(MouseEventArgs e, Node n) { IsDragging = true; DraggingNode = n; DragOffsetX = e.ClientX - n.X; DragOffsetY = e.ClientY - n.Y; }
    private void OnMouseMove(MouseEventArgs e) { if(IsDragging && DraggingNode != null) { DraggingNode.X = e.ClientX - DragOffsetX; DraggingNode.Y = e.ClientY - DragOffsetY; } }
    private void OnMouseUp(MouseEventArgs e) { if(IsDragging) { IsDragging = false; DraggingNode = null; SaveData(); } }
    private async void SaveData() { await JSRuntime.InvokeVoidAsync("appStorage.save", StorageKey, JsonSerializer.Serialize(new FlowData { Nodes = Nodes, Connections = Connections })); }

    public class Node { public Guid Id { get; set; } public double X { get; set; } public double Y { get; set; } public string Text { get; set; } = ""; }
    public class Connection { public Guid FromId { get; set; } public Guid ToId { get; set; } }
    public class FlowData { public List<Node> Nodes { get; set; } = new(); public List<Connection> Connections { get; set; } = new(); }
}
