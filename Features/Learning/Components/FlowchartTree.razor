@using MedicalSite.Features.Learning.Models

<div class="flex flex-col items-center">
    @if (Node != null)
    {
        <!-- 1. The Node Card -->
        <div class="z-20 flex flex-col items-center relative group">
            
            <!-- 
               Interactive Card 
               - node-card-transition: Custom smooth CSS class
               - hover:-translate-y-0.5: Very subtle lift
               - active:scale-98: Subtle press effect
            -->
            <div class="cursor-pointer rounded-xl border-2 px-5 py-3 shadow-sm min-w-[140px] max-w-[220px] text-center bg-white
                        node-card-transition hover:shadow-md hover:-translate-y-0.5 active:scale-98
                        @(GetColorClass(Node.Type))"
                 @onclick="ToggleExpand">
                
                <span class="font-bold text-sm leading-tight block text-slate-800">
                    @Node.Title
                </span>
                
                @if (!string.IsNullOrEmpty(Node.Description))
                {
                    <span class="mt-1.5 block text-[11px] opacity-80 leading-tight font-medium">
                        @Node.Description
                    </span>
                }

                <!-- Expand/Collapse Chevron -->
                @if (HasChildren)
                {
                    <div class="mt-2 flex justify-center">
                        <div class="h-5 w-5 rounded-full bg-black/5 flex items-center justify-center transition-transform duration-300 @(IsExpanded ? "rotate-180" : "")">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- 2. Children Container (Animated) -->
        @if (HasChildren && IsExpanded)
        {
            <div class="flex flex-col items-center animate-tree-enter">
                
                <!-- Vertical Line -->
                <div class="h-6 w-0.5 bg-slate-300 animate-line"></div>

                <!-- Horizontal Connector -->
                @if (Node.Children.Count > 1)
                {
                    <div class="relative h-0.5 bg-slate-300 w-full mb-6 animate-line"></div>
                }
                else
                {
                    <div class="mb-6"></div>
                }

                <!-- Recursive Children -->
                <div class="flex gap-4 items-start justify-center px-2">
                    @foreach (var child in Node.Children)
                    {
                        <div class="flex flex-col items-center relative">
                            <FlowchartTree Node="child" />
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public FlowchartNode Node { get; set; } = new();

    private bool IsExpanded { get; set; } = true;

    private bool HasChildren => Node.Children != null && Node.Children.Any();

    private void ToggleExpand()
    {
        if (HasChildren)
        {
            IsExpanded = !IsExpanded;
        }
    }

    // Professional Medical Color Palette (Tailwind)
    private string GetColorClass(string type) => type switch
    {
        // System: Neutral/Clinical Gray
        "System"   => "border-slate-600 bg-slate-50",
        
        // Receptor: Calm Blue (Signaling)
        "Receptor" => "border-blue-300 bg-blue-50 text-blue-900",
        
        // Action: Warm Amber (Physiology)
        "Action"   => "border-amber-300 bg-amber-50 text-amber-900",
        
        // Drug: Distinct Red/Rose (Intervention) - outlined ring for emphasis
        "Drug"     => "border-rose-300 bg-rose-50 text-rose-900 ring-1 ring-rose-100 ring-offset-1",
        
        // Start: Success Green
        "Start"    => "border-emerald-400 bg-emerald-50 text-emerald-900 font-bold",
        
        // Decision/Logic: Purple
        "Decision" => "border-purple-300 bg-purple-50 text-purple-900 italic",
        
        _          => "border-slate-200 bg-white text-slate-700"
    };
}